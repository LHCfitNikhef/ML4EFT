
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ml4eft.core.classifier &#8212; ML4EFT  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">ML4EFT  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Code
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../installation/instructions.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../installation/training.html">
   Tutorial
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../_autosummary/ml4eft.html">
   ml4eft
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.html">
     ml4eft.analyse
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.analyse.html">
       ml4eft.analyse.analyse
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
      <label for="toctree-checkbox-3">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html">
         ml4eft.analyse.analyse.Analyse
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.animate.html">
       ml4eft.analyse.animate
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
      <label for="toctree-checkbox-4">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.animate.Animate.html">
         ml4eft.analyse.animate.Animate
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.core.html">
     ml4eft.core
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.html">
       ml4eft.core.classifier
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
      <label for="toctree-checkbox-6">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.Classifier.html">
         ml4eft.core.classifier.Classifier
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.ConstraintActivation.html">
         ml4eft.core.classifier.ConstraintActivation
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.CustomActivationFunction.html">
         ml4eft.core.classifier.CustomActivationFunction
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.EventDataset.html">
         ml4eft.core.classifier.EventDataset
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.Fitter.html">
         ml4eft.core.classifier.Fitter
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.MLP.html">
         ml4eft.core.classifier.MLP
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.PreProcessing.html">
         ml4eft.core.classifier.PreProcessing
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.core.th_predictions.html">
       ml4eft.core.th_predictions
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
      <label for="toctree-checkbox-7">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.th_predictions.TheoryPred.html">
         ml4eft.core.th_predictions.TheoryPred
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.core.truth.html">
       ml4eft.core.truth
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
      <label for="toctree-checkbox-8">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.truth.tt_prod.html">
         ml4eft.core.truth.tt_prod
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.limits.html">
     ml4eft.limits
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.limits.optimize_ns.html">
       ml4eft.limits.optimize_ns
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
      <label for="toctree-checkbox-10">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.limits.optimize_ns.Optimize.html">
         ml4eft.limits.optimize_ns.Optimize
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.plotting.html">
     ml4eft.plotting
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
    <label for="toctree-checkbox-11">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.plotting.features.html">
       ml4eft.plotting.features
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
      <label for="toctree-checkbox-12">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.plotting.features.plot_features.html">
         ml4eft.plotting.features.plot_features
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.html">
     ml4eft.preproc
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
    <label for="toctree-checkbox-13">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.lhe_reader.html">
       ml4eft.preproc.lhe_reader
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
      <label for="toctree-checkbox-14">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.lhe_reader.get_deta.html">
         ml4eft.preproc.lhe_reader.get_deta
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.lhe_reader.get_dphi.html">
         ml4eft.preproc.lhe_reader.get_dphi
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.lhe_reader.Kinematics.html">
         ml4eft.preproc.lhe_reader.Kinematics
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Results
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../results/overview.html">
   Unbinned multivariate observables for global SMEFT analyses from machine learning
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
  <label for="toctree-checkbox-15">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../results/ttbar_analysis_parton.html">
     Inclusive top pair production at the parton level
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
    <label for="toctree-checkbox-16">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_parton1.html">
       Pseudo-data generation and benchmarking
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_parton2.html">
       Neural network training
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_parton3.html">
       Constraints on the SMEFT
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../results/ttbar_analysis.html">
     Inclusive top pair production at the particle level
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
    <label for="toctree-checkbox-17">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle1.html">
       Kinematic features used as inputs to the neural network
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle2.html">
       Results from the ML model vs binning in two features,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-2})\)
       </span>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle3.html">
       Results from the ML model trained on two features vs all features,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-2})\)
       </span>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle4.html">
       Results from the ML model vs binning in two features,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-4})\)
       </span>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle5.html">
       Results from the ML model training on two features vs all features,
       <span class="math notranslate nohighlight">
        \(O(Î›^{-4})\)
       </span>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../results/zh_analysis.html">
     Higgs production in association with a Z boson
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
    <label for="toctree-checkbox-18">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/zh_analysis1.html">
       Kinematic features used as inputs to the neural network
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/zh_analysis2.html">
       Results from the ML model vs binning in
       <span class="math notranslate nohighlight">
        \(p_{T}^{Z}\)
       </span>
       ,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-2})\)
       </span>
       , pair-wise fit
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/zh_analysis3.html">
       Results from the ML model vs binning in
       <span class="math notranslate nohighlight">
        \(p_{T}^{Z}\)
       </span>
       ,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-4})\)
       </span>
       , pair-wise fit
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/zh_analysis4.html">
       Results from the ML model vs binning in
       <span class="math notranslate nohighlight">
        \(p_{T}^{Z}\)
       </span>
       ,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-4})\)
       </span>
       , fully marginalised
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Bibliography
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../zrefs.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for ml4eft.core.classifier</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Binary classifier module</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># !/usr/bin/env python</span>
<span class="c1"># coding: utf-8</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span> <span class="k">as</span> <span class="nn">data</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">dump</span><span class="p">,</span> <span class="n">load</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rc</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">ml4eft.analyse.analyse</span> <span class="k">as</span> <span class="nn">analyse</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">RobustScaler</span><span class="p">,</span> <span class="n">QuantileTransformer</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Helvetica&#39;</span><span class="p">]})</span>
<span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="MLP"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.MLP.html#ml4eft.core.classifier.MLP">[docs]</a><span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Multi Layer Perceptron that serves as building block for the binary classifier</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MLP.__init__"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.MLP.html#ml4eft.core.classifier.MLP.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">architecture</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        architecture: array_like</span>
<span class="sd">            ``(N, ) ndarray`` that specifies the MLP&#39;s architecture as the number of input nodes followed</span>
<span class="sd">            by the number of hidden nodes in each consecutive hidden layer. The last entry must corespond</span>
<span class="sd">            to the number of output units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">input_size</span> <span class="o">=</span> <span class="n">architecture</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hidden_sizes</span> <span class="o">=</span> <span class="n">architecture</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_size</span> <span class="o">=</span> <span class="n">architecture</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Create the network based on the specified hidden sizes</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_size</span><span class="p">]</span> <span class="o">+</span> <span class="n">hidden_sizes</span>
        <span class="k">for</span> <span class="n">layer_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer_sizes</span><span class="p">)):</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">layer_sizes</span><span class="p">[</span><span class="n">layer_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">layer_sizes</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()]</span>
        <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">layer_sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">output_size</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="o">*</span><span class="n">layers</span><span class="p">)</span></div>

<div class="viewcode-block" id="MLP.forward"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.MLP.html#ml4eft.core.classifier.MLP.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a forward pass of the MLP</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x: array_like</span>
<span class="sd">            Input ``(N, ) torch.Tensor`` with ``N`` the number of input nodes</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out: torch.Tensor</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div></div>


<div class="viewcode-block" id="CustomActivationFunction"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.CustomActivationFunction.html#ml4eft.core.classifier.CustomActivationFunction">[docs]</a><span class="k">class</span> <span class="nc">CustomActivationFunction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to construct custom activation functions</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CustomActivationFunction.__init__"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.CustomActivationFunction.html#ml4eft.core.classifier.CustomActivationFunction.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span></div></div>


<div class="viewcode-block" id="ConstraintActivation"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.ConstraintActivation.html#ml4eft.core.classifier.ConstraintActivation">[docs]</a><span class="k">class</span> <span class="nc">ConstraintActivation</span><span class="p">(</span><span class="n">CustomActivationFunction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to transform the classifier output to ensure a positive likelihood ratio</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConstraintActivation.__init__"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.ConstraintActivation.html#ml4eft.core.classifier.ConstraintActivation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c: float</span>
<span class="sd">            Traning parameter :math:`c^{(\mathrm{tr})}` at which the EFT data set is generated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span></div>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">+</span> <span class="mf">1e-6</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">return</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span> <span class="mf">1e-6</span></div>


<div class="viewcode-block" id="Classifier"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Classifier.html#ml4eft.core.classifier.Classifier">[docs]</a><span class="k">class</span> <span class="nc">Classifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The decssion function :math:`g(x, c)`</span>

<span class="sd">    Implementation of the decision boundary `g(x, c)`</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Classifier.__init__"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Classifier.html#ml4eft.core.classifier.Classifier.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">architecture</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_alpha</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">architecture</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_alpha</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s1">&#39;constraint&#39;</span><span class="p">,</span> <span class="n">ConstraintActivation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">))</span></div>

<div class="viewcode-block" id="Classifier.forward"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Classifier.html#ml4eft.core.classifier.Classifier.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x: array_like</span>
<span class="sd">            Input ``(N, ) torch.Tensor`` with ``N`` the number of input nodes</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        g: Torch.Tensor</span>
<span class="sd">            decision boundary between two</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">NN_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_alpha</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">NN_out</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">g</span></div></div>


<div class="viewcode-block" id="PreProcessing"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.PreProcessing.html#ml4eft.core.classifier.PreProcessing">[docs]</a><span class="k">class</span> <span class="nc">PreProcessing</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A feature preprocessor and data loader</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PreProcessing.__init__"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.PreProcessing.html#ml4eft.core.classifier.PreProcessing.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitter</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fitter: :py:class:`Fitter &lt;ml4eft.core.classifier.Fitter&gt;`</span>
<span class="sd">            Fitter object</span>
<span class="sd">        path: dict</span>
<span class="sd">            Dictionary with paths to the SM and EFT dataset, e.g:</span>
<span class="sd">            :code:`{&#39;sm&#39;: &lt;path_to_sm_dataset&gt;, &#39;eft&#39;: &lt;path_to_eft_dataset&gt;}`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">if</span> <span class="n">fitter</span><span class="o">.</span><span class="n">scaler_type</span> <span class="o">==</span> <span class="s1">&#39;robust&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">(</span><span class="n">quantile_range</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">fitter</span><span class="o">.</span><span class="n">scaler_type</span> <span class="o">==</span> <span class="s1">&#39;standardise&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">QuantileTransformer</span><span class="p">(</span><span class="n">n_quantiles</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">output_distribution</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">fitter</span><span class="p">)</span></div>

<div class="viewcode-block" id="PreProcessing.load_data"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.PreProcessing.html#ml4eft.core.classifier.PreProcessing.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads ``pandas.DataFrame`` into SM and EFT dataframes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># sm</span>

        <span class="n">df_sm_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;sm&#39;</span><span class="p">],</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;infer&quot;</span><span class="p">)</span>
        <span class="n">df_sm_wo_xsec</span> <span class="o">=</span> <span class="n">df_sm_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>

        <span class="c1"># cross section before cuts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xsec_sm</span> <span class="o">=</span> <span class="n">df_sm_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_sm</span> <span class="o">=</span> <span class="n">df_sm_wo_xsec</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">fitter</span><span class="o">.</span><span class="n">n_dat</span><span class="p">)</span>

        <span class="c1"># eft</span>
        <span class="n">df_eft_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s1">&#39;eft&#39;</span><span class="p">],</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;infer&quot;</span><span class="p">)</span>
        <span class="n">df_eft_wo_xsec</span> <span class="o">=</span> <span class="n">df_eft_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>

        <span class="c1"># cross section before cuts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xsec_eft</span> <span class="o">=</span> <span class="n">df_eft_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_eft</span> <span class="o">=</span> <span class="n">df_eft_wo_xsec</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">fitter</span><span class="o">.</span><span class="n">n_dat</span><span class="p">)</span></div>

<div class="viewcode-block" id="PreProcessing.feature_scaling"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.PreProcessing.html#ml4eft.core.classifier.PreProcessing.feature_scaling">[docs]</a>    <span class="k">def</span> <span class="nf">feature_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitter</span><span class="p">,</span> <span class="n">scaler_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fitter: :py:class:`Fitter &lt;ml4eft.core.classifier.Fitter&gt;`</span>
<span class="sd">            Fitter object</span>
<span class="sd">        scaler_path: string</span>
<span class="sd">            Path to where preprocessing scaler must be saved</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_sm_scaled : pandas.DataFrame</span>
<span class="sd">            Rescaled SM events</span>

<span class="sd">        df_eft_scaled : pandas.DataFrame</span>
<span class="sd">            Rescaled EFT events</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df_sm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_eft</span><span class="p">])</span>

        <span class="c1"># fit the scaler transformer to the eft and sm features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">fitter</span><span class="o">.</span><span class="n">features</span><span class="p">])</span>

        <span class="c1"># rescale the sm and eft data</span>
        <span class="n">features_sm_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_sm</span><span class="p">[</span><span class="n">fitter</span><span class="o">.</span><span class="n">features</span><span class="p">])</span>
        <span class="n">features_eft_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_eft</span><span class="p">[</span><span class="n">fitter</span><span class="o">.</span><span class="n">features</span><span class="p">])</span>

        <span class="c1"># convert transformed features to dataframe</span>
        <span class="n">df_sm_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_sm_scaled</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">fitter</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
        <span class="n">df_eft_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_eft_scaled</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">fitter</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>

        <span class="c1"># save the scaler</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="p">,</span> <span class="n">scaler_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_sm_scaled</span><span class="p">,</span> <span class="n">df_eft_scaled</span></div></div>


<div class="viewcode-block" id="EventDataset"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.EventDataset.html#ml4eft.core.classifier.EventDataset">[docs]</a><span class="k">class</span> <span class="nc">EventDataset</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Event loader</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EventDataset.__init__"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.EventDataset.html#ml4eft.core.classifier.EventDataset.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">xsec</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">n_dat</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">hypothesis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EventDataset constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df: pandas.DataFrame</span>
<span class="sd">            Event DataFrame</span>
<span class="sd">        xsec: float</span>
<span class="sd">            inclusive cross-section</span>
<span class="sd">        path: str</span>
<span class="sd">            Path to dataset</span>
<span class="sd">        n_dat: int</span>
<span class="sd">            Number of data points</span>
<span class="sd">        features: array_like</span>
<span class="sd">            List of features to train on</span>
<span class="sd">        hypothesis: int</span>
<span class="sd">            0 for EFT and 1 for SM</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xsec</span> <span class="o">=</span> <span class="n">xsec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span> <span class="o">=</span> <span class="n">hypothesis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_loader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="EventDataset.event_loader"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.EventDataset.html#ml4eft.core.classifier.EventDataset.event_loader">[docs]</a>    <span class="k">def</span> <span class="nf">event_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the weights of the evevnts, labels and convert the events to torch.Tensor,</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">            Path to dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_dat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xsec</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_dat</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_dat</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_dat</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataset loaded from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">data_sample</span><span class="p">,</span> <span class="n">weight_sample</span><span class="p">,</span> <span class="n">label_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data_sample</span><span class="p">,</span> <span class="n">weight_sample</span><span class="p">,</span> <span class="n">label_sample</span></div>


<div class="viewcode-block" id="Fitter"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Fitter.html#ml4eft.core.classifier.Fitter">[docs]</a><span class="k">class</span> <span class="nc">Fitter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Training class</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Fitter.__init__"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Fitter.html#ml4eft.core.classifier.Fitter.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_path</span><span class="p">,</span> <span class="n">mc_run</span><span class="p">,</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">print_log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fitter constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json_path: str</span>
<span class="sd">            Path to json run card</span>
<span class="sd">        mc_run: int</span>
<span class="sd">            Replica number</span>
<span class="sd">        c_name: str</span>
<span class="sd">            EFT coefficient for which to learn the ratio function</span>
<span class="sd">        output_dir: str</span>
<span class="sd">            Path to where the models should be stored</span>
<span class="sd">        print_log: bool, optional</span>
<span class="sd">            Set to true to print training progress to stdout, otherwise it</span>
<span class="sd">            prints to a log file only</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read the json run card</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c_name</span> <span class="o">=</span> <span class="n">c_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s2">&quot;process_id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s2">&quot;n_batches&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;loss_type&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;scaler_type&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;val_ratio&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s2">&quot;c_train&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;n_dat&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_size</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;hidden_sizes&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;output_size&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_data_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">[</span><span class="s1">&#39;event_data&#39;</span><span class="p">]</span>  <span class="c1"># path to training data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">quadratic</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_name</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quadratic</span><span class="p">:</span>
            <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_train_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_train</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_train</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_train_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c_name</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mc_run</span> <span class="o">=</span> <span class="n">mc_run</span>

        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_name</span><span class="p">))</span>
        <span class="n">mc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;mc_run_</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_run</span><span class="p">))</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mc_path</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_path</span><span class="p">,</span>
                          <span class="s1">&#39;mc_path&#39;</span><span class="p">:</span> <span class="n">mc_path</span><span class="p">,</span>
                          <span class="s1">&#39;log_path&#39;</span><span class="p">:</span> <span class="n">log_path</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mc_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mc_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>

        <span class="c1"># initialise all paths to None, unless we run at pure quadratic or cross term level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_lin_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_lin_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_quad_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_quad_2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># build the paths to the eft event data and initialize the right model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quadratic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_dict</span><span class="p">[</span><span class="s1">&#39;eft_data_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{eft_coeff}</span><span class="s1">/events_</span><span class="si">{mc_run}</span><span class="s1">.pkl.gz&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Classifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_train_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># linear</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_dict</span><span class="p">[</span><span class="s1">&#39;eft_data_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{eft_coeff}</span><span class="s1">/events_</span><span class="si">{mc_run}</span><span class="s1">.pkl.gz&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Classifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_train_value</span><span class="p">)</span>

        <span class="c1"># create log file with timestamp</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H_%M_%S&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="c1"># print log to stdout when print_log is True, else only save to log file</span>
        <span class="k">if</span> <span class="n">print_log</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_path</span> <span class="o">+</span> <span class="s1">&#39;/training_</span><span class="si">{}</span><span class="s1">.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_time</span><span class="p">)),</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                        <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_path</span> <span class="o">+</span> <span class="s1">&#39;/training_</span><span class="si">{}</span><span class="s1">.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_time</span><span class="p">))]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> [</span><span class="si">%(levelname)s</span><span class="s2">] </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">handlers</span><span class="o">=</span><span class="n">handlers</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All directories created, ready to load the data&quot;</span><span class="p">)</span>

        <span class="c1"># load the training and validation data</span>
        <span class="n">data_train</span><span class="p">,</span> <span class="n">data_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

        <span class="c1"># copy run card to the appropriate folder</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mc_path</span> <span class="o">+</span> <span class="s1">&#39;run_card.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_options</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

        <span class="c1"># start the training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_classifier</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span> <span class="n">data_val</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fitter.load_data"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Fitter.html#ml4eft.core.classifier.Fitter.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs training and validation sets</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data_train: array_like</span>
<span class="sd">            Training data set</span>
<span class="sd">        data_val: array_like</span>
<span class="sd">            Validation data set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># event files are stored at event_data_path/sm, event_data_path/lin, event_data_path/quad</span>
        <span class="c1"># or event_data_path/cross for sm, linear, quadratic (single coefficient) and cross terms respectively</span>
        <span class="n">path_sm</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_data_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span> <span class="o">+</span> <span class="s1">&#39;_sm/events_</span><span class="si">{}</span><span class="s1">.pkl.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_run</span><span class="p">))</span>
        <span class="n">path_eft</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_data_path</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_dict</span><span class="p">[</span><span class="s1">&#39;eft_data_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eft_coeff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c_name</span><span class="p">,</span>
                                                                                               <span class="n">mc_run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_run</span><span class="p">))</span>

        <span class="n">path_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sm&#39;</span><span class="p">:</span> <span class="n">path_sm</span><span class="p">,</span> <span class="s1">&#39;eft&#39;</span><span class="p">:</span> <span class="n">path_eft</span><span class="p">}</span>

        <span class="c1"># preprocessing of the data</span>
        <span class="n">preproc</span> <span class="o">=</span> <span class="n">PreProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_dict</span><span class="p">)</span>

        <span class="c1"># save the scaler</span>
        <span class="n">scaler_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_dict</span><span class="p">[</span><span class="s1">&#39;mc_path&#39;</span><span class="p">],</span> <span class="s1">&#39;scaler.gz&#39;</span><span class="p">)</span>
        <span class="n">df_sm_scaled</span><span class="p">,</span> <span class="n">df_eft_scaled</span> <span class="o">=</span> <span class="n">preproc</span><span class="o">.</span><span class="n">feature_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scaler_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_dat</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_eft_scaled</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_sm_scaled</span><span class="p">))</span>

        <span class="c1"># construct an eft and a sm data set for each value of c in c_values and make a list out of it</span>
        <span class="n">data_eft</span> <span class="o">=</span> <span class="n">EventDataset</span><span class="p">(</span><span class="n">df_eft_scaled</span><span class="p">,</span>
                                <span class="n">xsec</span><span class="o">=</span><span class="n">preproc</span><span class="o">.</span><span class="n">xsec_eft</span><span class="p">,</span>
                                <span class="n">path</span><span class="o">=</span><span class="n">path_eft</span><span class="p">,</span>
                                <span class="n">n_dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_dat</span><span class="p">,</span>
                                <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                                <span class="n">hypothesis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">data_sm</span> <span class="o">=</span> <span class="n">EventDataset</span><span class="p">(</span><span class="n">df_sm_scaled</span><span class="p">,</span>
                               <span class="n">xsec</span><span class="o">=</span><span class="n">preproc</span><span class="o">.</span><span class="n">xsec_sm</span><span class="p">,</span>
                               <span class="n">path</span><span class="o">=</span><span class="n">path_sm</span><span class="p">,</span>
                               <span class="n">n_dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_dat</span><span class="p">,</span>
                               <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                               <span class="n">hypothesis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">data_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_eft</span><span class="p">,</span> <span class="n">data_sm</span><span class="p">]</span>

        <span class="c1"># split each data set in training and validation</span>
        <span class="n">data_split</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">data_all</span><span class="p">:</span>
            <span class="n">n_val_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
            <span class="n">n_train_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_val_points</span>
            <span class="n">data_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">n_train_points</span><span class="p">,</span> <span class="n">n_val_points</span><span class="p">]))</span>

        <span class="c1"># collect all the training and validation sets</span>
        <span class="n">data_train</span><span class="p">,</span> <span class="n">data_val</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">data_split</span><span class="p">:</span>
            <span class="n">data_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">data_train</span><span class="p">,</span> <span class="n">data_val</span></div>

<div class="viewcode-block" id="Fitter.train_classifier"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Fitter.html#ml4eft.core.classifier.Fitter.train_classifier">[docs]</a>    <span class="k">def</span> <span class="nf">train_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_train</span><span class="p">,</span> <span class="n">data_val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the training of the binary classifier</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_train: array_like</span>
<span class="sd">            Traning data set</span>
<span class="sd">        data_val: array_like</span>
<span class="sd">            Validation data set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define the optimizer</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>

        <span class="c1"># Use PyTorche&#39;s DataLoader to allow for mini-batches. After each epoch, the minibatches reshuffle.</span>
        <span class="c1"># Create a dataloader object for each eft point + sm and put them all in one big list called train_data_loader</span>
        <span class="c1"># or val_data_loader</span>
        <span class="n">train_data_loader</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dataset_train</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span>
            <span class="n">dataset_train</span> <span class="ow">in</span> <span class="n">data_train</span><span class="p">]</span>
        <span class="n">val_data_loader</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset_val</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dataset_val</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span>
            <span class="n">dataset_val</span> <span class="ow">in</span> <span class="n">data_val</span><span class="p">]</span>

        <span class="c1"># call the training loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_loop</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">train_loader</span><span class="o">=</span><span class="n">train_data_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="o">=</span><span class="n">val_data_loader</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fitter.training_loop"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Fitter.html#ml4eft.core.classifier.Fitter.training_loop">[docs]</a>    <span class="k">def</span> <span class="nf">training_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize the classifier with `optimizer` on the training data set `train_loader`. Keeps track of potential</span>
<span class="sd">        overfitting through `val_loader`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        optimizer: torch.optim</span>
<span class="sd">            Optimizer, e.g. torch.optim.AdamW</span>
<span class="sd">        train_loader: array_like</span>
<span class="sd">            List of torch.utils.data.DataLoader objects, one for the SM and the EFT (training)</span>
<span class="sd">        val_loader: array_like</span>
<span class="sd">            List of torch.utils.data.DataLoader objects, one for the SM and the EFT (validation)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_dict</span><span class="p">[</span><span class="s1">&#39;mc_path&#39;</span><span class="p">]</span>

        <span class="n">loss_list_train</span><span class="p">,</span> <span class="n">loss_list_val</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>  <span class="c1"># stores the training loss per epoch</span>

        <span class="c1"># To be able to keep track of potential over-fitting, introduce a counter that gets increased</span>
        <span class="c1"># by one whenever the the validation loss increases during an epoch</span>
        <span class="n">overfit_counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># outer loop that runs over the number of epochs</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

            <span class="c1"># check for plateau</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loss_list_train</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="c1"># if the loss after the first epoch queals the latest loss, we reset the weights</span>
                <span class="k">if</span> <span class="n">loss_list_train</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">loss_list_train</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detected stagant training, reset the weights&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_reset</span><span class="p">)</span>

            <span class="n">loss_train</span><span class="p">,</span> <span class="n">loss_val</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

            <span class="c1"># We save the model parameters at the start of each epoch</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;trained_nn_</span><span class="si">{}</span><span class="s1">.pt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>

            <span class="c1"># compute validation loss</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">minibatch</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">val_loader</span><span class="p">):</span>
                    <span class="n">val_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="n">event</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">label</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">minibatch</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">Classifier</span><span class="p">):</span>
                            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>

                        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
                        <span class="n">val_loss</span> <span class="o">+=</span> <span class="n">loss</span>
                    <span class="k">assert</span> <span class="n">val_loss</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">is</span> <span class="kc">False</span>

                    <span class="n">loss_val</span> <span class="o">+=</span> <span class="n">val_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="c1"># loop over the mini-batches.</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">minibatch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">train_loader</span><span class="p">)):</span>
                <span class="n">train_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># loop over all the datasets within the minibatch and compute their contribution to the loss</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="n">event</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">label</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">minibatch</span><span class="p">):</span>  <span class="c1"># i=0: eft, i=1: sm</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">Classifier</span><span class="p">):</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>

                    <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
                    <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span>

                <span class="c1"># perform gradient descent after each minibatch. Move to the next epoch when all minibatches are looped over.</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">train_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                <span class="n">loss_train</span> <span class="o">+=</span> <span class="n">train_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">loss_list_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_train</span><span class="p">)</span>
            <span class="n">loss_list_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_val</span><span class="p">)</span>

            <span class="n">training_status</span> <span class="o">=</span> <span class="s2">&quot;Epoch </span><span class="si">{epoch}</span><span class="s2">, Training loss </span><span class="si">{train_loss}</span><span class="s2">, Validation loss </span><span class="si">{val_loss}</span><span class="s2">, Overfit counter = </span><span class="si">{overfit}</span><span class="s2">&quot;</span><span class="o">.</span> \
                <span class="nb">format</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss</span><span class="o">=</span><span class="n">loss_train</span><span class="p">,</span> <span class="n">val_loss</span><span class="o">=</span><span class="n">loss_val</span><span class="p">,</span>
                       <span class="n">overfit</span><span class="o">=</span><span class="n">overfit_counter</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">training_status</span><span class="p">)</span>

            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;loss.out&#39;</span><span class="p">,</span> <span class="n">loss_list_train</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;loss_val.out&#39;</span><span class="p">,</span> <span class="n">loss_list_val</span><span class="p">)</span>

            <span class="c1"># in case the maximum number of epochs is reached, save the final state</span>
            <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;trained_nn.pt&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># check whether the network is overfitting by increasing the overfit_counter by one if the</span>
            <span class="c1"># validation loss increases during the epoch.</span>
            <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loss_val</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">loss_list_val</span><span class="p">):</span>
                    <span class="n">overfit_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">overfit_counter</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">overfit_counter</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="p">:</span>
                <span class="n">stopping_point</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping point reached! Overfit counter = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">overfit_counter</span><span class="p">))</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;trained_nn_</span><span class="si">{}</span><span class="s1">.pt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stopping_point</span><span class="p">),</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;trained_nn.pt&#39;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backwards stopping done&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">loss_val_old</span> <span class="o">=</span> <span class="n">loss_val</span>
            <span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished training&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fitter.weight_reset"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Fitter.html#ml4eft.core.classifier.Fitter.weight_reset">[docs]</a>    <span class="k">def</span> <span class="nf">weight_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the weights and biases associated with the model ``m``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        m: MLP</span>
<span class="sd">            Model of type :py:meth:`MLP &lt;MLP&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fitter.loss_fn"><a class="viewcode-back" href="../../../_autosummary/ml4eft.core.classifier.Fitter.html#ml4eft.core.classifier.Fitter.loss_fn">[docs]</a>    <span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">w_e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loss function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outputs: torch.Tensor</span>
<span class="sd">            Output of the decision function</span>
<span class="sd">        labels: torch.Tensor</span>
<span class="sd">            Classification labels</span>
<span class="sd">        w_e: torch.Tensor</span>
<span class="sd">            Event weights</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Average loss of the mini-batch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s1">&#39;CE&#39;</span><span class="p">:</span>

            <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="n">w_e</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">outputs</span><span class="p">)</span> <span class="o">-</span> <span class="n">labels</span> <span class="o">*</span> <span class="n">w_e</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s1">&#39;QC&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="n">w_e</span> <span class="o">*</span> <span class="n">outputs</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">labels</span> <span class="o">*</span> <span class="n">w_e</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">outputs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># average over all the losses in the batch</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div></div>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By R. Gomez Ambrosio, J. ter Hoeve, M. Madigan, J. Rojo, V. Sanz<br/>
  
      &copy; Copyright 2022, ML4EFT developer team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>