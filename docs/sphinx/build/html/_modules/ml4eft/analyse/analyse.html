
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ml4eft.analyse.analyse &#8212; ML4EFT  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">ML4EFT  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Code
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../installation/instructions.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../installation/training.html">
   Tutorial
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../_autosummary/ml4eft.html">
   ml4eft
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.html">
     ml4eft.analyse
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.analyse.html">
       ml4eft.analyse.analyse
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
      <label for="toctree-checkbox-3">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html">
         ml4eft.analyse.analyse.Analyse
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.animate.html">
       ml4eft.analyse.animate
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
      <label for="toctree-checkbox-4">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.analyse.animate.Animate.html">
         ml4eft.analyse.animate.Animate
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.core.html">
     ml4eft.core
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.html">
       ml4eft.core.classifier
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
      <label for="toctree-checkbox-6">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.Classifier.html">
         ml4eft.core.classifier.Classifier
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.ConstraintActivation.html">
         ml4eft.core.classifier.ConstraintActivation
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.CustomActivationFunction.html">
         ml4eft.core.classifier.CustomActivationFunction
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.EventDataset.html">
         ml4eft.core.classifier.EventDataset
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.Fitter.html">
         ml4eft.core.classifier.Fitter
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.MLP.html">
         ml4eft.core.classifier.MLP
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.classifier.PreProcessing.html">
         ml4eft.core.classifier.PreProcessing
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.core.th_predictions.html">
       ml4eft.core.th_predictions
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
      <label for="toctree-checkbox-7">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.th_predictions.TheoryPred.html">
         ml4eft.core.th_predictions.TheoryPred
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.core.truth.html">
       ml4eft.core.truth
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
      <label for="toctree-checkbox-8">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.core.truth.tt_prod.html">
         ml4eft.core.truth.tt_prod
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.limits.html">
     ml4eft.limits
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.limits.optimize_ns.html">
       ml4eft.limits.optimize_ns
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
      <label for="toctree-checkbox-10">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.limits.optimize_ns.Optimize.html">
         ml4eft.limits.optimize_ns.Optimize
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.plotting.html">
     ml4eft.plotting
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
    <label for="toctree-checkbox-11">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.plotting.features.html">
       ml4eft.plotting.features
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
      <label for="toctree-checkbox-12">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.plotting.features.plot_features.html">
         ml4eft.plotting.features.plot_features
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.html">
     ml4eft.preproc
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
    <label for="toctree-checkbox-13">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.lhe_reader.html">
       ml4eft.preproc.lhe_reader
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
      <label for="toctree-checkbox-14">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.lhe_reader.get_deta.html">
         ml4eft.preproc.lhe_reader.get_deta
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.lhe_reader.get_dphi.html">
         ml4eft.preproc.lhe_reader.get_dphi
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/ml4eft.preproc.lhe_reader.Kinematics.html">
         ml4eft.preproc.lhe_reader.Kinematics
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Results
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../results/overview.html">
   Unbinned multivariate observables for global SMEFT analyses from machine learning
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
  <label for="toctree-checkbox-15">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../results/ttbar_analysis_parton.html">
     Inclusive top pair production at the parton level
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
    <label for="toctree-checkbox-16">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_parton1.html">
       Pseudo-data generation and benchmarking
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_parton2.html">
       Neural network training
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_parton3.html">
       Constraints on the SMEFT
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../results/ttbar_analysis.html">
     Inclusive top pair production at the particle level
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
    <label for="toctree-checkbox-17">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle1.html">
       Kinematic features used as inputs to the neural network
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle2.html">
       Results from the ML model vs binning in two features,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-2})\)
       </span>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle3.html">
       Results from the ML model trained on two features vs all features,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-2})\)
       </span>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle4.html">
       Results from the ML model vs binning in two features,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-4})\)
       </span>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/ttbar_analysis_particle5.html">
       Results from the ML model training on two features vs all features,
       <span class="math notranslate nohighlight">
        \(O(Λ^{-4})\)
       </span>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../results/zh_analysis.html">
     Higgs production in association with a Z boson
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
    <label for="toctree-checkbox-18">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/zh_analysis1.html">
       Kinematic features used as inputs to the neural network
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/zh_analysis2.html">
       Results from the ML model vs binning in
       <span class="math notranslate nohighlight">
        \(p_{T}^{Z}\)
       </span>
       ,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-2})\)
       </span>
       , pair-wise fit
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/zh_analysis3.html">
       Results from the ML model vs binning in
       <span class="math notranslate nohighlight">
        \(p_{T}^{Z}\)
       </span>
       ,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-4})\)
       </span>
       , pair-wise fit
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../results/zh_analysis4.html">
       Results from the ML model vs binning in
       <span class="math notranslate nohighlight">
        \(p_{T}^{Z}\)
       </span>
       ,
       <span class="math notranslate nohighlight">
        \(O(\Lambda^{-4})\)
       </span>
       , fully marginalised
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Bibliography
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../zrefs.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for ml4eft.analyse.analyse</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Post-training analysing module to load, plot and evaluates models</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gridspec</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">NullFormatter</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="c1"># import own pacakges</span>
<span class="kn">from</span> <span class="nn">ml4eft.core</span> <span class="kn">import</span> <span class="n">classifier</span> <span class="k">as</span> <span class="n">classifier</span>
<span class="kn">from</span> <span class="nn">ml4eft.core.truth</span> <span class="kn">import</span> <span class="n">tt_prod</span> <span class="k">as</span> <span class="n">axs</span>
<span class="kn">from</span> <span class="nn">ml4eft.core.truth</span> <span class="kn">import</span> <span class="n">vh_prod</span><span class="p">,</span> <span class="n">tt_prod</span>
<span class="kn">from</span> <span class="nn">..preproc</span> <span class="kn">import</span> <span class="n">constants</span>

<span class="n">mz</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">mz</span>  <span class="c1"># z boson mass [TeV]</span>
<span class="n">mh</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">mh</span>
<span class="n">mt</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">mt</span>
<span class="n">col_s</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">col_s</span>

<span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Helvetica&#39;</span><span class="p">],</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">})</span>
<span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="Analyse"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse">[docs]</a><span class="k">class</span> <span class="nc">Analyse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Post-training analyser that loads and evaluates models</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Analyse.__init__"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_models</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;quad&#39;</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_to_models: dict</span>
<span class="sd">            Of the form {&#39;lin&#39;: {&#39;c1&#39;: ``&lt;path_to_c1_models&gt;``, &#39;c2&#39;: ``&lt;path_to_c2_models&gt;``}, &#39;quad&#39;: {&#39;c1_c1&#39;: ``&lt;path_to_c1_c1_models&gt;``},</span>
<span class="sd">            {&#39;c1_c2&#39;: ``&lt;path_to_c1_c2_models&gt;``}, {&#39;c2_c2&#39;: ``&lt;path_to_c2_c2_models&gt;``}}</span>
<span class="sd">        order: str, default=&#39;quad&#39;</span>
<span class="sd">            The order in the EFT expansion (choose between either &#39;lin&#39; or &#39;quad&#39;)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Trained models can be loaded by creating an :class:`ml4eft.analyse.analyse.Analyse` object</span>

<span class="sd">        &gt;&gt;&gt; analyser = Analyse(path_to_models, &#39;quad&#39;)</span>

<span class="sd">        Followed by constructing a model dictionary that contains all the models plus associated settings</span>

<span class="sd">        &gt;&gt;&gt; analyser.build_model_dict()</span>
<span class="sd">        &gt;&gt;&gt; analyser.model_df</span>
<span class="sd">                        models              idx             scalers                                       run_card              rep_paths</span>
<span class="sd">        lin  c1         [Classifier() ...   [rep_idx, ...]  [RobustScaler(quantile_range=(5,95)), ...]    {&#39;name&#39;: &#39;c1&#39;, ...}   [&lt;path_to_rep&gt;, ...]</span>
<span class="sd">             c2         [Classifier() ...   ...             ...                                           ...                   ...</span>
<span class="sd">        quad c1_c1      [Classifier() ...   ...             ...                                           ...                   ...</span>
<span class="sd">             c1_c2      [Classifier() ...   ...             ...                                           ...                   ...</span>
<span class="sd">             c2_c2      [Classifier() ...   ...             ...                                           ...                   ...</span>

<span class="sd">        Events and the inclusive cross-section can be loaded into a DataFrame by</span>

<span class="sd">        &gt;&gt;&gt; df, xsec = analyser.load_events(&#39;.../events_&lt;rep&gt;.pkl.gz&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df</span>
<span class="sd">                  sqrts_hat       pt_l1       pt_l2  pt_l_leading  pt_l_trailing   ...</span>
<span class="sd">        1       1702.356400   20.532279  308.295118    308.295118      20.532279   ...</span>
<span class="sd">        2       ...           ...        ...           ...             ...</span>

<span class="sd">        To evaluate the models on the loaded DataFrame ``df``, use:</span>

<span class="sd">        &gt;&gt;&gt; analyser.evaluate_models(df)</span>
<span class="sd">        &gt;&gt;&gt; analyser.models_evaluated_df[&#39;models&#39;]</span>
<span class="sd">        &gt;&gt;&gt; analyser.models_evaluated_df[&#39;models&#39;]</span>
<span class="sd">        lin   c1            [[0.05130317, 0.05723376, 0.058220766, 0.04042...</span>
<span class="sd">              c2            [[0.074420996, 0.10293982, 0.10705493, 0.05695...</span>
<span class="sd">        quad  c1_c1         [[0.07958487, 0.13463444, 0.14215767, 0.049889...</span>
<span class="sd">              c1_c2         [[0.0005354581, 0.00042073405, 0.0004430262, -...</span>
<span class="sd">              c2_c2         [[0.00032746396, 0.00041523552, 0.00045115477,...</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path_to_models</span> <span class="o">=</span> <span class="n">path_to_models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models_evaluated_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff_truth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Analyse.get_event_paths"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.get_event_paths">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_event_paths</span><span class="p">(</span><span class="n">root_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of paths to the DataFrames at ``root_path``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        root_path: str</span>
<span class="sd">            path to the DataFrame directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        event_paths: list</span>
<span class="sd">            list of paths to the DataFrames at stored at ``root_path``</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        The paths to the event DataFrames stored at ``root_path`` can be loaded for &#39;n_rep&#39; replicas by</span>

<span class="sd">        &gt;&gt;&gt; analyser.get_event_paths(&#39;/training_data/tt_llvlvlbb/tt_c1&#39;)</span>
<span class="sd">        [/training_data/tt_llvlvlbb/tt_c1/events_0.pkl.gz&#39;, ... , /training_data/tt_llvlvlbb/tt_c1/events_&lt;n_rep&gt;.pkl.gz&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">mc_run</span><span class="p">)</span> <span class="k">for</span> <span class="n">mc_run</span> <span class="ow">in</span>
                       <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">mc_run</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;events_&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">event_paths</span></div>

<div class="viewcode-block" id="Analyse.build_path_dict"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.build_path_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">build_path_dict</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct path to model dictionary</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        root: str</span>
<span class="sd">            Path to the model root directory</span>
<span class="sd">        order: str</span>
<span class="sd">            Order of the EFT expansion, choose between &#39;lin&#39; and &#39;quad&#39;</span>
<span class="sd">        prefix: str</span>
<span class="sd">            For models: `prefix` = ``models``, for theory predictions: `prefix` = ``process_id`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        path_to_models: dict</span>
<span class="sd">            Dictionary containing the paths to the models for each EFT ratio function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path_to_models</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span>
            <span class="n">path_to_models</span><span class="p">[</span><span class="s1">&#39;sm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_sm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>

        <span class="n">path_to_models</span><span class="p">[</span><span class="s1">&#39;lin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
            <span class="n">path_to_models</span><span class="p">[</span><span class="s1">&#39;quad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">model_dir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;sm&#39;</span> <span class="ow">in</span> <span class="n">model_dir</span><span class="p">:</span> <span class="c1"># sm has already been added</span>
                    <span class="k">continue</span>
                <span class="c1"># linear</span>
                <span class="k">if</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">path_to_models</span><span class="p">[</span><span class="s1">&#39;lin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">model_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">)})</span>

                <span class="k">if</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
                    <span class="n">path_to_models</span><span class="p">[</span><span class="s1">&#39;quad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">model_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">)})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">path_to_models</span></div>

<div class="viewcode-block" id="Analyse.posterior_loader"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.posterior_loader">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">posterior_loader</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads the posterior samples at ``path`` and converts it to a DataFrame</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">            Location of posterior samples (.json file)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df: pandas.DataFrame</span>
<span class="sd">            DataFrame of the posterior samples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_data</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Analyse.load_events"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.load_events">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_events</span><span class="p">(</span><span class="n">event_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a event DataFrame and splits it into the events and the inclusive cross section</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event_path: str</span>
<span class="sd">            Path to the DataFrame (including the xsec as first row)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        events: pandas.DataFrame</span>
<span class="sd">            DataFrame with events</span>
<span class="sd">        xsec: float</span>
<span class="sd">            Inclusive cross-section of the events</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">event_path</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">event_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="n">xsec</span> <span class="o">=</span> <span class="n">event_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">events</span><span class="p">,</span> <span class="n">xsec</span></div>

<div class="viewcode-block" id="Analyse.load_loss"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.load_loss">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_loss</span><span class="p">(</span><span class="n">path_to_loss</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loades the losses per epoch into a list</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_to_loss: str</span>
<span class="sd">            Path to loss file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loss: list</span>
<span class="sd">            list of losses per epoch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_loss</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">loss</span></div>

<div class="viewcode-block" id="Analyse.load_run_card"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.load_run_card">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_run_card</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads training run card</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">            path to json model run card that stores the hyperparameter settings</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        run_card: dict</span>
<span class="sd">            dict with all the hyperparameter settings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_data</span><span class="p">:</span>
            <span class="n">run_card</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">run_card</span><span class="p">[</span><span class="s1">&#39;architecture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">run_card</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">])]</span> <span class="o">+</span> <span class="n">run_card</span><span class="p">[</span><span class="s1">&#39;hidden_sizes&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">run_card</span><span class="p">[</span><span class="s1">&#39;output_size&#39;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">run_card</span></div>

<div class="viewcode-block" id="Analyse.filter_out_models"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.filter_out_models">[docs]</a>    <span class="k">def</span> <span class="nf">filter_out_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">losses</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter out the badly trained models based on kmeans clustering.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        losses: array_like</span>
<span class="sd">            Losses of all the trained models</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        good_model_idx: numpy.ndarray</span>
<span class="sd">            Array indices of the &#39;good&#39; models</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_clusters</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">losses</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span>
        <span class="n">cluster_nr_low_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span><span class="p">)</span>

        <span class="c1"># find model indices in the low loss cluster</span>
        <span class="n">good_model_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">cluster_nr_low_loss</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># if relative std has not been reduced by a factor 10, select only models within +- 4 sigma</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">losses</span><span class="p">[</span><span class="n">good_model_idx</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">sigma_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">los_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

            <span class="n">good_model_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span>
                <span class="p">(</span><span class="n">los_med</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">sigma_loss</span> <span class="o">&lt;</span> <span class="n">losses</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">losses</span> <span class="o">&lt;</span> <span class="n">los_med</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">sigma_loss</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">good_model_idx</span></div>

<div class="viewcode-block" id="Analyse.load_models"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.load_models">[docs]</a>    <span class="k">def</span> <span class="nf">load_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">rep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the trained models</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_path: str</span>
<span class="sd">            path to model directory</span>
<span class="sd">        rep: int, optional</span>
<span class="sd">            Load only a specific replica specified by ``rep``. Load all replicas by default.</span>
<span class="sd">        epoch: int, optional</span>
<span class="sd">            Model at specific epoch to load. Set to the best model by default.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        models: array_like</span>
<span class="sd">            ``(N,) ndarray`` containing the loaded neural networks</span>

<span class="sd">        models_rep_nr: array_like</span>
<span class="sd">            ``(N,) ndarray`` containing the replica numbers of the loaded neural networks</span>

<span class="sd">        scalers: array_like</span>
<span class="sd">            ``(N,) ndarray`` containing the preprocessing scalers of the loaded neural networks</span>

<span class="sd">        run_card: dict</span>
<span class="sd">            training run card of the trained models</span>

<span class="sd">        rep_paths: array_like</span>
<span class="sd">            ``(N,) ndarray`` with the paths to the neural networks</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># collect all replica paths when no specific replica is requested</span>
        <span class="k">if</span> <span class="n">rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rep_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">mc_run</span><span class="p">)</span> <span class="k">for</span> <span class="n">mc_run</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span> <span class="k">if</span>
                         <span class="n">mc_run</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;mc_run&#39;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rep_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;mc_run_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rep</span><span class="p">))]</span>

        <span class="n">losses_tr</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store the final training losses</span>
        <span class="n">losses_val</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store the final validation losses</span>

        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scalers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">rep_path</span> <span class="ow">in</span> <span class="n">rep_paths</span><span class="p">:</span>

            <span class="n">path_to_run_card</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep_path</span><span class="p">,</span> <span class="s1">&#39;run_card.json&#39;</span><span class="p">)</span>
            <span class="n">path_to_scaler</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep_path</span><span class="p">,</span> <span class="s1">&#39;scaler.gz&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_to_scaler</span><span class="p">):</span>  <span class="c1"># if model did not get trained, jump to the next one</span>
                <span class="n">rep_paths</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rep_path</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">run_card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_run_card</span><span class="p">(</span><span class="n">path_to_run_card</span><span class="p">)</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path_to_scaler</span><span class="p">)</span>

            <span class="n">model_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
            <span class="n">c_name</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;model_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c_train</span> <span class="o">=</span> <span class="n">run_card</span><span class="p">[</span><span class="s1">&#39;c_train&#39;</span><span class="p">]</span>

            <span class="n">quadratic</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">c_name</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">quadratic</span><span class="p">:</span>
                <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">c_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">c_train_value</span> <span class="o">=</span> <span class="n">c_train</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c_train</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c_train_value</span> <span class="o">=</span> <span class="n">c_train</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

            <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">Classifier</span><span class="p">(</span><span class="n">run_card</span><span class="p">[</span><span class="s1">&#39;architecture&#39;</span><span class="p">],</span> <span class="n">c_train_value</span><span class="p">)</span>

            <span class="c1"># build path to model config file</span>
            <span class="k">if</span> <span class="n">epoch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># if specific epoch is requested</span>
                <span class="n">network_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep_path</span><span class="p">,</span> <span class="s1">&#39;trained_nn_</span><span class="si">{}</span><span class="s1">.pt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">network_path</span><span class="p">):</span>
                    <span class="n">network_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep_path</span><span class="p">,</span> <span class="s1">&#39;trained_nn.pt&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">network_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep_path</span><span class="p">,</span> <span class="s1">&#39;trained_nn.pt&#39;</span><span class="p">)</span>

            <span class="c1"># load the model</span>
            <span class="n">loaded_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">network_path</span><span class="p">))</span>

            <span class="c1"># read the losses</span>
            <span class="n">path_to_loss_tr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep_path</span><span class="p">,</span> <span class="s1">&#39;loss.out&#39;</span><span class="p">)</span>
            <span class="n">path_to_loss_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep_path</span><span class="p">,</span> <span class="s1">&#39;loss_val.out&#39;</span><span class="p">)</span>

            <span class="n">loss_tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_loss</span><span class="p">(</span><span class="n">path_to_loss_tr</span><span class="p">)</span>
            <span class="n">loss_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_loss</span><span class="p">(</span><span class="n">path_to_loss_val</span><span class="p">)</span>

            <span class="c1"># load all the parameters into the trained network and save</span>
            <span class="n">losses_tr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_tr</span><span class="p">[</span><span class="o">-</span><span class="n">run_card</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]])</span>
            <span class="n">losses_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_val</span><span class="p">[</span><span class="o">-</span><span class="n">run_card</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]])</span>

            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loaded_model</span><span class="p">)</span>
            <span class="n">scalers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scaler</span><span class="p">)</span>

        <span class="n">losses_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">losses_tr</span><span class="p">)</span>
        <span class="n">losses_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">losses_val</span><span class="p">)</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
        <span class="n">scalers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scalers</span><span class="p">)</span>

        <span class="c1"># filter out the badly trained models based on their training loss only if all replicas</span>
        <span class="c1"># have been included</span>
        <span class="n">models_rep_nr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">good_model_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_out_models</span><span class="p">(</span><span class="n">losses_tr</span><span class="p">)</span>
            <span class="n">models</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">good_model_idx</span><span class="p">]</span>
            <span class="n">scalers</span> <span class="o">=</span> <span class="n">scalers</span><span class="p">[</span><span class="n">good_model_idx</span><span class="p">]</span>

            <span class="c1"># map model indices back to rep number</span>
            <span class="n">models_rep_nr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">good_model_idx</span><span class="p">:</span>
                <span class="n">rep_nr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rep_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;mc_run_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">models_rep_nr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rep_nr</span><span class="p">)</span>
            <span class="n">models_rep_nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">models_rep_nr</span><span class="p">)</span>

            <span class="n">rep_paths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rep_paths</span><span class="p">)[</span><span class="n">good_model_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">models</span><span class="p">,</span> <span class="n">models_rep_nr</span><span class="p">,</span> <span class="n">scalers</span><span class="p">,</span> <span class="n">run_card</span><span class="p">,</span> <span class="n">rep_paths</span></div>

<div class="viewcode-block" id="Analyse.build_model_dict"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.build_model_dict">[docs]</a>    <span class="k">def</span> <span class="nf">build_model_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a DataFrame with loaded models plus associated info</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rep: int, optional</span>
<span class="sd">            Replica number in case a specific replica is requested</span>
<span class="sd">        epoch: int, optional</span>
<span class="sd">            Epoch to load, set to the best model by default</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">dict_fo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_to_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;lin&#39;</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>  <span class="c1"># skip quadratics when running linear</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">model_path</span> <span class="ow">in</span> <span class="n">dict_fo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">pretrained_models</span><span class="p">,</span> <span class="n">models_idx</span><span class="p">,</span> <span class="n">scalers</span><span class="p">,</span> <span class="n">run_card</span><span class="p">,</span> <span class="n">rep_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_models</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">c_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;models&#39;</span><span class="p">:</span> <span class="n">pretrained_models</span><span class="p">,</span> <span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">models_idx</span><span class="p">,</span> <span class="s1">&#39;scalers&#39;</span><span class="p">:</span> <span class="n">scalers</span><span class="p">,</span>
                                                  <span class="s1">&#39;run_card&#39;</span><span class="p">:</span> <span class="n">run_card</span><span class="p">,</span> <span class="s1">&#39;rep_paths&#39;</span><span class="p">:</span> <span class="n">rep_paths</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span>
                                               <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyse.evaluate_models"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.evaluate_models">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">rep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates the loaded models on a Pandas DataFrame ``df``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df: pd.DataFrame</span>
<span class="sd">            input to the models</span>
<span class="sd">        rep: int, optional</span>
<span class="sd">            Replica number in case a specific replica is requested.</span>
<span class="sd">            Set to ``None`` by default in which case all available replicas are included.</span>
<span class="sd">        epoch: int, optional</span>
<span class="sd">            Epoch number to load. Set to the best model by default.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># load models if not done already</span>
        <span class="k">if</span> <span class="n">rep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_model_dict</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_model_dict</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>

        <span class="n">models_evaluated</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">dict_fo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">dict_c</span> <span class="ow">in</span> <span class="n">dict_fo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">models</span> <span class="o">=</span> <span class="n">dict_c</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
                    <span class="n">features</span> <span class="o">=</span> <span class="n">dict_c</span><span class="p">[</span><span class="s1">&#39;run_card&#39;</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
                    <span class="n">features_scaled</span> <span class="o">=</span> <span class="n">dict_c</span><span class="p">[</span><span class="s1">&#39;scalers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>
                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                        <span class="n">model_ev</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">n_alpha</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">models_evaluated</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">c_name</span><span class="p">][</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_ev</span>

                <span class="n">models_evaluated</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">c_name</span><span class="p">][</span><span class="s1">&#39;models&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">models_evaluated</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">c_name</span><span class="p">][</span><span class="s1">&#39;models&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">models_evaluated_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span> <span class="n">models_evaluated</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                                                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">models_evaluated</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                                           <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">models_evaluated</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span>
                                                          <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyse.coeff_function_truth"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.coeff_function_truth">[docs]</a>    <span class="k">def</span> <span class="nf">coeff_function_truth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates the analytic EFT ratio functions :math:`r_{\sigma}^{(i)}` and :math:`r_{\sigma}^{(i,j)}`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df: pandas.DataFrame</span>
<span class="sd">            Events on which to evaluate :math:`r_{\sigma}^{(i)}` and :math:`r_{\sigma}^{(i,j)}`</span>
<span class="sd">        c_name: str</span>
<span class="sd">            Name of the EFT coefficient. Choose between &#39;ctgre&#39;, &#39;cut&#39;, &#39;cut_cut&#39;, &#39;ctgre_ctgre&#39;</span>
<span class="sd">        features: list</span>
<span class="sd">            Kinematic features, options are ``m_tt``, ``y``</span>
<span class="sd">        process: str</span>
<span class="sd">            Supported options are &#39;tt&#39; or &#39;ZH&#39;</span>
<span class="sd">        order: str</span>
<span class="sd">            Order of the EFT expansion, choose between &#39;lin&#39; and &#39;quad&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        coeff: array_like</span>
<span class="sd">            ``(N,) ndarray`` with :math:`r_{\sigma}^{(i)}` or :math:`r_{\sigma}^{(i,j)}` evaluated on ``df`` depending</span>
<span class="sd">            on the ``order``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">c_name</span> <span class="o">==</span> <span class="s1">&#39;ctGRe&#39;</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;lin&#39;</span><span class="p">:</span>
            <span class="n">cprime</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ctGRe&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ctu8&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">c_name</span> <span class="o">==</span> <span class="s1">&#39;ctu8&#39;</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;lin&#39;</span><span class="p">:</span>
            <span class="n">cprime</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ctGRe&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ctu8&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">c_name</span> <span class="o">==</span> <span class="s1">&#39;ctGRe_ctGRe&#39;</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
            <span class="n">cprime</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ctGRe&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ctu8&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="n">c_name</span> <span class="o">=</span> <span class="s1">&#39;ctGRe&#39;</span>
        <span class="k">if</span> <span class="n">c_name</span> <span class="o">==</span> <span class="s1">&#39;ctu8_ctu8&#39;</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
            <span class="n">cprime</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ctGRe&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ctu8&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
            <span class="n">c_name</span> <span class="o">=</span> <span class="s1">&#39;ctu8&#39;</span>

        <span class="c1"># ratio_truth_lin = self.likelihood_ratio_truth(df, cprime, features, process, order)</span>

        <span class="n">ratio_truth_lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_ratio_truth</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cprime</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="c1"># compute the mask once to select the physical region in phase space</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ratio_truth_lin</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;lin&#39;</span><span class="p">:</span>  <span class="c1"># only one of the c elements can be nonzero</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio_truth_lin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">cprime</span><span class="p">[</span><span class="n">c_name</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">coeff</span>
        <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>  <span class="c1"># only one of the c elements can be nonzero</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio_truth_lin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">cprime</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">coeff</span></div>

<div class="viewcode-block" id="Analyse.accuracy_heatmap"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.accuracy_heatmap">[docs]</a>    <span class="k">def</span> <span class="nf">accuracy_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">mx_cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compares the NN and true EFT ratio functions and plots their ratio and pull</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c_name: str</span>
<span class="sd">            Name of the EFT parameter, e.g. &#39;ctgre&#39;</span>
<span class="sd">        order: str</span>
<span class="sd">            Order in the EFT expansion, options are &#39;lin&#39; or &#39;quad&#39;</span>
<span class="sd">        process: str</span>
<span class="sd">            Specifies the process. Currently supported is &#39;tt&#39; and &#39;ZH&#39;</span>
<span class="sd">        mx_cut: list, optional</span>
<span class="sd">            Plot range of the invariant mass</span>
<span class="sd">        rep: int, optional</span>
<span class="sd">            Request to plot for a specific replica</span>
<span class="sd">        epoch: int, optional</span>
<span class="sd">            Request to plot for a specific epoch.</span>
<span class="sd">        ax: matplotlib.pyplot.axes, optional</span>
<span class="sd">            Axes to plot on</span>
<span class="sd">        text: str, optional</span>
<span class="sd">            Add additional text on the heatmap such as the replica number</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matplotlib.figure.Figure</span>
<span class="sd">            Heatmap of EFT ratio function</span>
<span class="sd">        `matplotlib.figure.Figure`</span>
<span class="sd">            Heatmap of associated pull</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        For a single EFT coefficient :math:`c_{tG}` the likelihood ratio takes the form</span>

<span class="sd">        .. math::</span>

<span class="sd">            r_{\sigma}(x, c_{tG}) = 1 + c_{tG} r_{\sigma}^{(c_{tG})} + c_{tG}^2 r_{\sigma}^{(c_{tG}, c_{tG})}</span>

<span class="sd">        To plot for example the accuracy of :math:`r_{\sigma}^{(c_{tG}, c_{tG})}` by plotting its ratio to the exact</span>
<span class="sd">        result, one runs</span>

<span class="sd">        &gt;&gt;&gt; fig_med, fig_pull = analyser.accuracy_heatmap(&#39;ctgre_ctgre&#39;, &#39;quad&#39;, &#39;tt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fig_med</span>

<span class="sd">        .. image:: ../images/heatmap_med.png</span>

<span class="sd">        &gt;&gt;&gt; fig_pull</span>

<span class="sd">        .. image:: ../images/heatmap_pull.png</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">col_s</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-2</span>

        <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mx_cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mx_min</span><span class="p">,</span> <span class="n">mx_max</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">+</span> <span class="n">mh</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">,</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mx_min</span><span class="p">,</span> <span class="n">mx_max</span> <span class="o">=</span> <span class="n">mx_cut</span>

        <span class="k">elif</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;tt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mx_cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mx_min</span><span class="p">,</span> <span class="n">mx_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mt</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">,</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mx_min</span><span class="p">,</span> <span class="n">mx_max</span> <span class="o">=</span> <span class="n">mx_cut</span>

        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">mx_min</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">mx_min</span><span class="p">)</span>

        <span class="n">x_spacing</span><span class="p">,</span> <span class="n">y_spacing</span> <span class="o">=</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mf">0.01</span>
        <span class="n">mx_span</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mx_min</span><span class="p">,</span> <span class="n">mx_max</span><span class="p">,</span> <span class="n">x_spacing</span><span class="p">)</span>
        <span class="n">y_span</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">y_spacing</span><span class="p">)</span>

        <span class="n">mx_grid</span><span class="p">,</span> <span class="n">y_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">mx_span</span><span class="p">,</span> <span class="n">y_span</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">mx_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">grid</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;m_zh&#39;</span><span class="p">:</span> <span class="n">grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]})</span>
        <span class="k">elif</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;tt&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">grid</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;m_tt&#39;</span><span class="p">:</span> <span class="n">grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]})</span>

        <span class="c1"># models</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_models</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_evaluated_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="n">c_name</span><span class="p">][</span><span class="s1">&#39;models&#39;</span><span class="p">]</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
        <span class="n">n_models</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">nn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_models</span><span class="p">,</span> <span class="o">*</span><span class="n">mx_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="c1"># truth</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff_truth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coeff_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff_function_truth</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">mx_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$m_</span><span class="si">{ZH}</span><span class="s1">\;\rm{[TeV]}$&#39;</span> <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;ZH&#39;</span> <span class="k">else</span> <span class="sa">r</span><span class="s1">&#39;$m_{t\bar</span><span class="si">{t}</span><span class="s1">}\;\rm{[TeV]}$&#39;</span>
        <span class="k">if</span> <span class="n">rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># determine median, low and high CI</span>

            <span class="n">nn_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nn_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nn_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nn_unc</span> <span class="o">=</span> <span class="p">(</span><span class="n">nn_high</span> <span class="o">-</span> <span class="n">nn_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="c1"># median</span>
            <span class="n">median_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff_truth</span> <span class="o">/</span> <span class="n">nn_median</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\rm{Unbinned\;exact/Unbinned\;ML}$&#39;</span>

            <span class="n">fig_1</span><span class="p">,</span> <span class="n">ax_1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

            <span class="n">im_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_heatmap</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">median_ratio</span><span class="p">,</span>
                                     <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
                                     <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$y_{t\bar</span><span class="si">{t}</span><span class="s1">}$&#39;</span><span class="p">,</span>
                                     <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                                     <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">mx_min</span><span class="p">,</span> <span class="n">mx_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">],</span>
                                     <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span>
                                     <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">,</span> <span class="mf">1.04</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">],</span>
                                     <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># pull</span>

            <span class="n">fig_2</span><span class="p">,</span> <span class="n">ax_2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

            <span class="n">pull</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_truth</span> <span class="o">-</span> <span class="n">nn_median</span><span class="p">)</span> <span class="o">/</span> <span class="n">nn_unc</span>

            <span class="n">im_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_heatmap</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pull</span><span class="p">,</span>
                                     <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
                                     <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$y_{t\bar</span><span class="si">{t}</span><span class="s1">}$&#39;</span><span class="p">,</span>
                                     <span class="n">title</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\rm</span><span class="si">{Pull}</span><span class="s1">$&#39;</span><span class="p">,</span>
                                     <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">mx_min</span><span class="p">,</span> <span class="n">mx_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">],</span>
                                     <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span>
                                     <span class="n">bounds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                                     <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\mathrm{{Truth/NN}}\;(\mathrm{{rep}}\;</span><span class="si">{}</span><span class="s2">)$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_heatmap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff_truth</span> <span class="o">/</span> <span class="n">nn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
                                   <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$y_{t\bar</span><span class="si">{t}</span><span class="s1">}$&#39;</span><span class="p">,</span>
                                   <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                                   <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">mx_min</span><span class="p">,</span> <span class="n">mx_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">],</span>
                                   <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span>
                                   <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">,</span> <span class="mf">1.04</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">],</span>
                                   <span class="n">rep</span><span class="o">=</span><span class="n">rep</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">im</span></div>

<div class="viewcode-block" id="Analyse.plot_heatmap_overview"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.plot_heatmap_overview">[docs]</a>    <span class="k">def</span> <span class="nf">plot_heatmap_overview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">mx_cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produces an overview of heatmaps showing in each plot the ratio between the ML model prediction and</span>
<span class="sd">        the analytical EFT ratio function :math:`r_{\sigma}^{(i)}` or :math:`r_{\sigma}^{(i, j)}`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c_name: str</span>
<span class="sd">            Name of EFT coefficient</span>
<span class="sd">        order: str</span>
<span class="sd">            Order in the EFT expansion</span>
<span class="sd">        process: str</span>
<span class="sd">            Specifies the process, choose between &#39;tt&#39; and &#39;ZH&#39;</span>
<span class="sd">        mx_cut: float, optional</span>
<span class="sd">            Plot range of the invariant mass</span>
<span class="sd">        reps: int, optional</span>
<span class="sd">            Number of replicas to include in the heatmap overview</span>
<span class="sd">        epoch: int, optional</span>
<span class="sd">            Specific epoch to plot at, takes the best models by default</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib.figure</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        To produce a heatmap overview of the first 20 replicas, run</span>

<span class="sd">        &gt;&gt;&gt; analyser = Analyse(path_to_models, &#39;quad&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fig = analyser.plot_heatmap_overview(&#39;ctgre_ctgre&#39;, &#39;quad&#39;, &#39;tt&#39;, cut=0.5, reps=np.arange(20))</span>
<span class="sd">        &gt;&gt;&gt; fig</span>

<span class="sd">        .. image:: ../images/heatmap_overview.png</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">AxesGrid</span>

        <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Helvetica&#39;</span><span class="p">],</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>

        <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">mc_reps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reps</span><span class="p">)</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mc_reps</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">))</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span>
                        <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">),</span>
                        <span class="n">axes_pad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                        <span class="n">cbar_mode</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>
                        <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                        <span class="n">cbar_pad</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                        <span class="n">cbar_size</span><span class="o">=</span><span class="mf">0.5</span>
                        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reps</span><span class="p">):</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_heatmap</span><span class="p">(</span><span class="n">c_name</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">mx_cut</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Analyse.likelihood_ratio_nn"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.likelihood_ratio_nn">[docs]</a>    <span class="k">def</span> <span class="nf">likelihood_ratio_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the Neural Network parameterised likelihood ratio</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c: dict</span>
<span class="sd">            Of the form {&#39;c1&#39;: value, &#39;c2&#39;: value, ...}</span>
<span class="sd">        df: pandas.DataFrame, optional</span>
<span class="sd">            In case the loaded models have not been evaluated yet, one can pass ``df`` to evaluate the neural networks</span>
<span class="sd">        epoch: int, optional</span>
<span class="sd">            Specify an epoch if necessary, takes the best model by default</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ratio: array_like</span>
<span class="sd">            likelihood ratio as ``(N,M) ndarray`` with ``N`` and ``M`` the number of replicas and events respectively</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update evaluated models for a new df</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_models</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="s1">&#39;lin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_evaluated_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">lin_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_evaluated_df</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;lin&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">c_val</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">lin_models</span><span class="p">:</span>
                    <span class="n">ratio</span> <span class="o">+=</span> <span class="n">c_val</span> <span class="o">*</span> <span class="n">lin_models</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;quad&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_evaluated_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">quad_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_evaluated_df</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;quad&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">c_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">quad_models</span><span class="p">:</span>
                    <span class="n">ratio</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span> <span class="o">*</span> <span class="n">quad_models</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)]</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ratio</span></div>

<div class="viewcode-block" id="Analyse.decision_function_nn"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.decision_function_nn">[docs]</a>    <span class="k">def</span> <span class="nf">decision_function_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the Neural Network parameterised decision function :math:`g(x, c)`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df: pd.DataFrame</span>
<span class="sd">            event info</span>
<span class="sd">        c: dict</span>
<span class="sd">            EFT point</span>
<span class="sd">        epoch: int, optional</span>
<span class="sd">            Use models at a specific epoch, set to -1 (best modeL) by default</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        decision_function: numpy.ndarray</span>
<span class="sd">            NN decision function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_ratio_nn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
        <span class="n">decision_function</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ratio</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decision_function</span></div>

<div class="viewcode-block" id="Analyse.point_by_point_comp_med"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.point_by_point_comp_med">[docs]</a>    <span class="k">def</span> <span class="nf">point_by_point_comp_med</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produces a point by point comparison of the log-likelihood ratio between the (median) ML model and the analytical</span>
<span class="sd">        (exact) model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df: pandas.DataFrame</span>
<span class="sd">            DataFrame with events</span>
<span class="sd">        c: dict</span>
<span class="sd">            Of the form {&#39;c1&#39;: value, &#39;c2&#39;: value}</span>
<span class="sd">        features: array_like</span>
<span class="sd">            List of features to include in the comparison</span>
<span class="sd">        process: str</span>
<span class="sd">            Choose between ``tt`` or ``ZH``</span>
<span class="sd">        order: str</span>
<span class="sd">            Specifies the order in the EFT expansion. Must be one of ``lin``, ``quad``.</span>
<span class="sd">        ax: matplotlib.axes</span>
<span class="sd">            Axes object to plot on</span>
<span class="sd">        text: str</span>
<span class="sd">            Additonal text to put on the plot</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; analyser = Analyse(path_to_models, &#39;quad&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fig, ax = plt.subplots()</span>

<span class="sd">        &gt;&gt;&gt; events_sm = pd.read_pickle(&#39;&lt;events_sm_0.pkl.gz&gt;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; analyser.point_by_point_comp_med(events_sm, {&#39;ctgre&#39;: 2, &#39;cut&#39;: 0}, [&#39;y&#39;, &#39;m_tt&#39;], &#39;tt&#39;, &#39;lin&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fig</span>

<span class="sd">        .. image:: ../images/pbp-med.png</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r_nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_ratio_nn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="n">tau_nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r_nn</span><span class="p">)</span>

        <span class="n">r_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_ratio_truth</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="n">tau_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r_truth</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau_truth</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau_truth</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tau_truth</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tau_nn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log r(x, c)^{\rm</span><span class="si">{Unbinned}</span><span class="s1">\;\rm</span><span class="si">{exact}</span><span class="s1">}$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log r(x, c)^{\rm</span><span class="si">{Unbinned}</span><span class="s1">\;\rm</span><span class="si">{ML}</span><span class="s1">}$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>

<div class="viewcode-block" id="Analyse.point_by_point_comp"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.point_by_point_comp">[docs]</a>    <span class="k">def</span> <span class="nf">point_by_point_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Produces a point by point comparison overview per replica of the log-likelihood ratio between the ML model</span>
<span class="sd">       and the analytical (exact) model</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       df: pandas.DataFrame</span>
<span class="sd">           DataFrame with events</span>
<span class="sd">       c_name: str</span>
<span class="sd">            name of EFT ratio function to compare, e.g. ``c1_c2``</span>
<span class="sd">       c: dict</span>
<span class="sd">           Of the form {&#39;c1&#39;: value, &#39;c2&#39;: value}</span>
<span class="sd">       features: array_like</span>
<span class="sd">           List of features to include in the comparison</span>
<span class="sd">       process: str</span>
<span class="sd">           Choose between ``tt`` or ``ZH``</span>
<span class="sd">       order: str</span>
<span class="sd">           Specifies the order in the EFT expansion. Must be one of ``lin``, ``quad``.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       &gt;&gt;&gt; analyser = Analyse(path_to_models, &#39;quad&#39;)</span>
<span class="sd">       &gt;&gt;&gt; fig, ax = plt.subplots()</span>

<span class="sd">       &gt;&gt;&gt; events_sm = pd.read_pickle(&#39;&lt;events_sm_0.pkl.gz&gt;&#39;)</span>
<span class="sd">       &gt;&gt;&gt; analyser.point_by_point_comp(events_sm, {&#39;ctgre&#39;: -2, &#39;cut&#39;: 0}, [&#39;y&#39;, &#39;m_tt&#39;], &#39;tt&#39;, &#39;lin&#39;)</span>
<span class="sd">       &gt;&gt;&gt; fig</span>

<span class="sd">       .. image:: ../images/pbp_overview.png</span>

<span class="sd">       &quot;&quot;&quot;</span>

        <span class="n">r_nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_ratio_nn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="n">tau_nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r_nn</span><span class="p">)</span>

        <span class="n">r_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_ratio_truth</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="n">tau_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r_truth</span><span class="p">)</span>

        <span class="c1"># overview plot for all replicas</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">mc_reps</span> <span class="o">=</span> <span class="n">r_nn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mc_reps</span> <span class="o">/</span> <span class="n">ncols</span><span class="p">))</span>

        <span class="n">fig1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">ncols</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau_truth</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau_truth</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="c1"># for k, v in c.items():</span>
        <span class="c1">#     if v != 0:</span>
        <span class="c1">#         import pdb; pdb.set_trace()</span>
        <span class="c1">#         model_idx = self.model_df.loc[order, k][&#39;idx&#39;]</span>
        <span class="n">model_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="n">c_name</span><span class="p">][</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">model_idx</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">model_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># plt.scatter(tau_truth[mask_comp], tau_nn[i, mask_comp], s=2, color=&#39;k&#39;)</span>
            <span class="c1"># plt.scatter(tau_truth[mask], tau_nn[i, mask], s=2, color=&#39;red&#39;)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tau_truth</span><span class="p">,</span> <span class="n">tau_nn</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\mathrm{{rep}}\;</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                     <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># median</span>
        <span class="n">fig2</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau_truth</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau_truth</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="c1"># plt.scatter(tau_truth[mask_comp], np.median(tau_nn, axis=0)[mask_comp], s=5, color=&#39;k&#39;)</span>
        <span class="c1"># plt.scatter(tau_truth[mask], np.median(tau_nn, axis=0)[mask], s=5, color=&#39;red&#39;)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tau_truth</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tau_nn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log r(x, c)^{\rm</span><span class="si">{Unbinned}</span><span class="s1">\;\rm</span><span class="si">{exact}</span><span class="s1">}$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log r(x, c)^{\rm</span><span class="si">{Unbinned}</span><span class="s1">\;\rm</span><span class="si">{ML}</span><span class="s1">}$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig1</span><span class="p">,</span> <span class="n">fig2</span></div>

<div class="viewcode-block" id="Analyse.plot_loss_overview"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.plot_loss_overview">[docs]</a>    <span class="k">def</span> <span class="nf">plot_loss_overview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the loss evolution per replica and returns an overview plot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c_name: str</span>
<span class="sd">            name of EFT parameter</span>
<span class="sd">        order: str</span>
<span class="sd">            Specifies the order in the EFT expansion. Must be one of ``lin``, ``quad``.</span>
<span class="sd">        ax: matplotlib.axes, optional</span>
<span class="sd">            Axes object to plot on</span>
<span class="sd">        rep: int, optional</span>
<span class="sd">            Specific replica to plot</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib.figure</span>
<span class="sd">            Loss overview plot</span>

<span class="sd">        train_loss_best: array_like</span>
<span class="sd">            List of &#39;best&#39; training losses</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        To plot a loss overview corresponding to the training of :math:`r_{\sigma}^{(c_{tG}, c_{tG})}`, run</span>

<span class="sd">        &gt;&gt;&gt; analyser = Analyse(path_to_models, &#39;quad&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fig, train_losses = analyser.plot_loss_overview(&#39;ctgre_ctgre&#39;, &#39;quad&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fig</span>

<span class="sd">        .. image:: ../images/loss_overview.png</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_model_dict</span><span class="p">()</span>

        <span class="n">rep_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;rep_paths&#39;</span><span class="p">][</span><span class="n">order</span><span class="p">][</span><span class="n">c_name</span><span class="p">]</span>

        <span class="n">loss_tr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">loss_val</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">mc_reps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rep_paths</span><span class="p">)</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mc_reps</span> <span class="o">/</span> <span class="n">ncols</span><span class="p">))</span>

        <span class="n">patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="n">c_name</span><span class="p">][</span><span class="s1">&#39;run_card&#39;</span><span class="p">][</span><span class="s1">&#39;patience&#39;</span><span class="p">]</span>
        <span class="n">model_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="n">c_name</span><span class="p">][</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">rep_path</span> <span class="ow">in</span> <span class="n">rep_paths</span><span class="p">:</span>
            <span class="n">path_to_loss_tr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep_path</span><span class="p">,</span> <span class="s1">&#39;loss.out&#39;</span><span class="p">)</span>
            <span class="n">loss_tr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_loss</span><span class="p">(</span><span class="n">path_to_loss_tr</span><span class="p">))</span>

            <span class="n">path_to_loss_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep_path</span><span class="p">,</span> <span class="s1">&#39;loss_val.out&#39;</span><span class="p">)</span>
            <span class="n">loss_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_loss</span><span class="p">(</span><span class="n">path_to_loss_val</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">ncols</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">train_loss_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">loss</span><span class="p">[</span><span class="o">-</span><span class="n">patience</span><span class="p">]</span> <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">loss_tr</span><span class="p">])</span>
        <span class="n">val_loss_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">loss</span><span class="p">[</span><span class="o">-</span><span class="n">patience</span><span class="p">]</span> <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">loss_val</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">model_idx</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">rep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rep</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">model_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">epochs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loss_tr</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

            <span class="n">label_val</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$L_{\mathrm</span><span class="si">{val}</span><span class="s1">}$&#39;</span> <span class="k">if</span> <span class="n">model_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">label_train</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$L_{\mathrm</span><span class="si">{tr}</span><span class="s1">}$&#39;</span> <span class="k">if</span> <span class="n">model_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">loss_train_rep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss_tr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">loss_val_rep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss_val</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">loss_train_rep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">loss_val_rep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">loss_sigma_val</span><span class="p">,</span> <span class="n">loss_sigma_tr</span><span class="p">),</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">loss_train_rep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">loss_val_rep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">loss_sigma_val</span><span class="p">,</span> <span class="n">loss_sigma_tr</span><span class="p">))</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">loss_train_rep</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_train</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">loss_val_rep</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_val</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">[</span><span class="n">xlim</span><span class="p">:],</span> <span class="n">loss_train_rep</span><span class="p">[</span><span class="n">xlim</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="n">label_train</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">[</span><span class="n">xlim</span><span class="p">:],</span> <span class="n">loss_val_rep</span><span class="p">[</span><span class="n">xlim</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="n">label_val</span><span class="p">)</span>


            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">epochs</span><span class="p">[</span><span class="o">-</span><span class="n">patience</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>

            <span class="c1"># ax.set_yscale(&#39;log&#39;)</span>
            <span class="c1"># ax.yaxis.set_major_formatter(NullFormatter())</span>
            <span class="c1"># ax.yaxis.set_minor_formatter(NullFormatter())</span>
            <span class="c1"># ax.axes.yaxis.set_ticklabels([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ymargin</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xmargin</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\mathrm{{rep}}\;</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>




            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{Epoch}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{Loss}</span><span class="s1">$&#39;</span><span class="p">)</span>

            <span class="n">med_loss_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">train_loss_best</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">low_loss_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">train_loss_best</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">high_loss_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">train_loss_best</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
            <span class="n">loss_sigma_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">high_loss_tr</span> <span class="o">-</span> <span class="n">low_loss_tr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">med_loss_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">val_loss_best</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">low_loss_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">val_loss_best</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">high_loss_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">val_loss_best</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
            <span class="n">loss_sigma_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">high_loss_val</span> <span class="o">-</span> <span class="n">low_loss_val</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># same scale (not everything visible)</span>

            <span class="c1"># ax.set_ylim(min(loss_train_rep[-1], loss_val_rep[-1]) - 0.2 * max(loss_sigma_val, loss_sigma_tr),</span>
            <span class="c1">#             min(loss_train_rep[-1], loss_val_rep[-1]) + 2 * max(loss_sigma_val, loss_sigma_tr))</span>

            <span class="c1"># everything visible (not the same scale)</span>



            <span class="k">if</span> <span class="n">model_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">train_loss_best</span></div>

<div class="viewcode-block" id="Analyse.plot_accuracy_1d"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.plot_accuracy_1d">[docs]</a>    <span class="k">def</span> <span class="nf">plot_accuracy_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">mx_cut</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the decision boundary :math:`g(x,c)` as predicted by the ML model and the analytical (exact) model along</span>
<span class="sd">        1 dimension, i.e :x=math:`m_{tt}`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c: dict</span>
<span class="sd">            Of the form {&#39;c1&#39;: value, &#39;c2&#39;: value}</span>
<span class="sd">        process: str</span>
<span class="sd">            Choose between ``tt`` or ``ZH``</span>
<span class="sd">        order: str, optional</span>
<span class="sd">            Specifies the order in the EFT expansion. Must be one of ``lin``, ``quad``.</span>
<span class="sd">        mx_cut: list</span>
<span class="sd">            Plot range of the invariant mass</span>
<span class="sd">        epoch: int, optional</span>
<span class="sd">            Specific epoch to plot, set to the best models by default</span>
<span class="sd">        ax: matplotlib.axes, optional</span>
<span class="sd">            Plot on an already created axes object</span>
<span class="sd">        text: str, optional</span>
<span class="sd">            Additional text to show on the plot</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib.figure</span>
<span class="sd">            Plot comparing the decision boundary :math:`g(x,c)` as predicted by the ML model and the analytical (exact)</span>
<span class="sd">            result</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; analyser = Analyse(path_to_models, &#39;quad&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fig = analyser.plot_accuracy_1d(c={&#39;ctgre&#39;: -2, &#39;cut&#39;: 0}, process=&#39;tt&#39;, order=&#39;quad&#39;, cut=0.5, text=r&#39;$c=c_{tG}=2\;\mathrm{quadratic}$&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fig</span>

<span class="sd">        .. image:: ../images/decission_function_1d.png</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mx_cut</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mx_cut</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;tt&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;m_tt&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;m_zh&#39;</span><span class="p">])</span>

        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;run_card&#39;</span><span class="p">][</span><span class="n">order</span><span class="p">][</span><span class="n">c_name</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="c1"># TODO: order not correct</span>


        <span class="n">f_ana_lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_function_truth</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="n">f_preds_nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_function_nn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>

        <span class="n">f_pred_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">f_preds_nn</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f_pred_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">f_preds_nn</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">f_pred_down</span><span class="p">,</span> <span class="n">f_pred_up</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\mathrm</span><span class="si">{Unbinned}</span><span class="s2">\;\mathrm</span><span class="si">{ML}</span><span class="s2">\;(m_{t\bar</span><span class="si">{t}</span><span class="s2">}, y_{t\bar</span><span class="si">{t}</span><span class="s2">})$&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">f_ana_lin</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\mathrm</span><span class="si">{Unbinned}</span><span class="s2">\;\mathrm</span><span class="si">{exact}</span><span class="s2">\;(m_{t\bar</span><span class="si">{t}</span><span class="s2">}, y_{t\bar</span><span class="si">{t}</span><span class="s2">})$&quot;</span><span class="p">)</span>

        <span class="c1"># single replica</span>
        <span class="c1"># ax.plot(x[:, 0], f_preds_nn[0,:], &#39;--&#39;, c=&#39;blue&#39;, label=r&#39;$\rm{NN}\;\mathcal{O}\left(\Lambda^{-2}\right)$&#39;)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$g\;(x, c)$&#39;</span><span class="p">)</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$m_</span><span class="si">{ZH}</span><span class="s1">\;\rm{[TeV]}$&#39;</span> <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;ZH&#39;</span> <span class="k">else</span> <span class="sa">r</span><span class="s1">&#39;$m_{t\bar</span><span class="si">{t}</span><span class="s1">}\;\rm{[TeV]}$&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Analyse.likelihood_ratio_truth"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.likelihood_ratio_truth">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">likelihood_ratio_truth</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the analytic likelihood ratio :math:`r(x, c)`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order: str, optional</span>
<span class="sd">            Specifies the order in the EFT expansion. Must be one of ``lin``, ``quad``.</span>
<span class="sd">        process: str</span>
<span class="sd">            Choose between ``tt`` or ``ZH``</span>
<span class="sd">        features: list</span>
<span class="sd">            List of kinematic labels</span>
<span class="sd">        events : pd.DataFrame</span>
<span class="sd">            Pandas DataFrame with the events</span>
<span class="sd">        c : dict</span>
<span class="sd">            EFT point with operator names specified as keys</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ratio: numpy.ndarray</span>
<span class="sd">            Likelihood ratio wrt the SM</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;cHW&#39;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;cHq3&#39;</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">n_features</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dsigma_0</span> <span class="o">=</span> <span class="p">[</span><span class="n">vh_prod</span><span class="o">.</span><span class="n">dsigma_dmvh</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># EFT</span>
                <span class="n">dsigma_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">vh_prod</span><span class="o">.</span><span class="n">dsigma_dmvh</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">])</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># SM</span>
            <span class="k">elif</span> <span class="n">n_features</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">dsigma_0</span> <span class="o">=</span> <span class="p">[</span><span class="n">vh_prod</span><span class="o">.</span><span class="n">dsigma_dmvh_dy</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># EFT</span>
                <span class="n">dsigma_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">vh_prod</span><span class="o">.</span><span class="n">dsigma_dmvh_dy</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">])</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># SM</span>
            <span class="k">elif</span> <span class="n">n_features</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">dsigma_0</span> <span class="o">=</span> <span class="p">[</span><span class="n">vh_prod</span><span class="o">.</span><span class="n">dsigma_dmvh_dy_dpt</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="k">for</span>
                            <span class="n">index</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># EFT</span>
                <span class="n">dsigma_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">vh_prod</span><span class="o">.</span><span class="n">dsigma_dmvh_dy_dpt</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">])</span> <span class="k">for</span>
                            <span class="n">index</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># SM</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No more than three features are currently supported&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;tt&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;ctGRe&#39;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;ctu8&#39;</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">n_features</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dsigma_0</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt_prod</span><span class="o">.</span><span class="n">dsigma_dmtt</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># EFT</span>
                <span class="n">dsigma_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt_prod</span><span class="o">.</span><span class="n">dsigma_dmtt</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># SM</span>
            <span class="k">elif</span> <span class="n">n_features</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">dsigma_0</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt_prod</span><span class="o">.</span><span class="n">dsigma_dmtt_dy</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># EFT</span>
                <span class="n">dsigma_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt_prod</span><span class="o">.</span><span class="n">dsigma_dmtt_dy</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># SM</span>
            <span class="k">elif</span> <span class="n">n_features</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">dsigma_0</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt_prod</span><span class="o">.</span><span class="n">dsigma_dmtt_dy_dpt</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">c</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="k">for</span>
                            <span class="n">index</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># EFT</span>
                <span class="n">dsigma_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt_prod</span><span class="o">.</span><span class="n">dsigma_dmtt_dy_dpt</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">features</span><span class="p">])</span> <span class="k">for</span>
                            <span class="n">index</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>  <span class="c1"># SM</span>

        <span class="n">dsigma_0</span><span class="p">,</span> <span class="n">dsigma_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dsigma_0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dsigma_1</span><span class="p">)</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">dsigma_0</span><span class="p">,</span> <span class="n">dsigma_1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dsigma_0</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">dsigma_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ratio</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span></div>

<div class="viewcode-block" id="Analyse.decision_function_truth"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.decision_function_truth">[docs]</a>    <span class="k">def</span> <span class="nf">decision_function_truth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the analytic decision function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order: str, optional</span>
<span class="sd">            Specifies the order in the EFT expansion. Must be one of ``lin``, ``quad``.</span>
<span class="sd">        process: str</span>
<span class="sd">            Choose between ``tt`` or ``ZH``</span>
<span class="sd">        features: list</span>
<span class="sd">            List of kinematic labels</span>
<span class="sd">        events : pd.DataFrame</span>
<span class="sd">            Pandas DataFrame with the events</span>
<span class="sd">        c : numpy.ndarray, shape=(M,)</span>
<span class="sd">            EFT point in M dimensions, e.g c = (cHW, cHq3)</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        decision_function: numpy.ndarray</span>
<span class="sd">            Truth decision function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_ratio_truth</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="n">decision_function</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ratio</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decision_function</span></div>

<div class="viewcode-block" id="Analyse.plot_heatmap"><a class="viewcode-back" href="../../../_autosummary/ml4eft.analyse.analyse.Analyse.html#ml4eft.analyse.analyse.Analyse.plot_heatmap">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_heatmap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;GnBu&#39;</span><span class="p">,</span> <span class="n">rep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot and return a heatmap of ``data``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: numpy.ndarray, shape=(M, N)</span>
<span class="sd">            Input array</span>
<span class="sd">        xlabel: str</span>
<span class="sd">            x-label</span>
<span class="sd">        ylabel: str</span>
<span class="sd">            y-label</span>
<span class="sd">        title: str</span>
<span class="sd">            title of plot</span>
<span class="sd">        extent: list</span>
<span class="sd">            boundaries of the heatmap, e.g. [x_0, x_1, y_1, y_2]</span>
<span class="sd">        bounds: list</span>
<span class="sd">            The boundaries of the discrete colourmap</span>
<span class="sd">        cmap: str</span>
<span class="sd">            colourmap to use, set to &#39;GnBu&#39; by default</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: `matplotlib.figure.Figure`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">tick</span>

        <span class="c1"># discrete colorbar</span>
        <span class="n">cmap_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">))</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap_copy</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="n">cmap_copy</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gainsboro&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>
            <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Helvetica&#39;</span><span class="p">],</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_copy</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\mathrm{{rep}}\;</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rep</span><span class="p">),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_copy</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                <span class="nb">format</span><span class="o">=</span><span class="n">tick</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$</span><span class="si">%.2f</span><span class="s1">$&#39;</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">im</span></div></div>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By R. Gomez Ambrosio, J. ter Hoeve, M. Madigan, J. Rojo, V. Sanz<br/>
  
      &copy; Copyright 2022, ML4EFT developer team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>